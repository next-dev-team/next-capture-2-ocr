<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>OCR Screen Capture</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      /* Drag selection overlay styles */
      .drag-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.3);
        z-index: 10000;
        cursor: crosshair;
        display: none;
        user-select: none;
        -webkit-user-select: none;
        -webkit-app-region: no-drag;
      }

      .selection-area {
        position: absolute;
        border: 2px solid #007aff;
        background: rgba(0, 122, 255, 0.1);
        display: none;
        pointer-events: none;
      }

      .drag-instructions {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 20px 30px;
        border-radius: 8px;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        font-size: 16px;
        z-index: 10001;
        pointer-events: none;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <!-- Drag Selection Overlay -->
    <div class="drag-overlay" id="dragOverlay">
      <div class="drag-instructions" id="dragInstructions">
        🎯 Click and drag to select an area for OCR<br />
        <small>Press ESC to cancel</small>
      </div>
      <div class="selection-area" id="selectionArea"></div>
    </div>

    <div class="app-header">
      <h1 class="app-title">📸 Capture to OCR</h1>
      <p class="app-subtitle">Extract text from any area of your screen</p>
      <div class="header-buttons">
        <button
          class="settings-icon"
          id="languageManagementIcon"
          title="Language Management"
        >
          🌍
        </button>
        <button class="settings-icon" id="settingsIcon" title="Settings">
          ⚙️
        </button>
      </div>
    </div>

    <!-- Permission Banner (hidden by default) -->
    <div class="permission-banner" id="permissionBanner" style="display: none">
      <div class="permission-title">
        🔒 Screen Recording Permission Required
      </div>
      <div class="permission-text">
        <p>
          This app needs permission to capture your screen for OCR processing.
        </p>
        <div class="permission-steps">
          <p><strong>To enable screen recording:</strong></p>
          <ol>
            <li>Click "Open System Preferences" below</li>
            <li>Find and check the box next to "OCR Screen Capture"</li>
            <li>Click "Recheck Permissions" when done</li>
          </ol>
        </div>
      </div>
      <div class="permission-buttons">
        <button class="permission-button primary" id="openPreferencesBtn">
          Open System Preferences
        </button>
        <button class="permission-button secondary" id="recheckPermissionBtn">
          Recheck Permissions
        </button>
      </div>
    </div>

    <!-- Configuration Section -->
    <div class="config-section" id="configSection" style="display: none">
      <div class="section-header">
        <div class="section-title">Settings</div>
        <button class="back-icon" id="backIcon" title="Back">←</button>
      </div>

      <!-- Language Settings -->
      <div class="config-row">
        <label class="config-label">Language:</label>
        <select class="language-dropdown" id="languageSelect">
          <option value="auto">🔍 Auto Detect</option>
          <option value="eng">🇺🇸 English</option>
        </select>
      </div>

      <!-- Capture Mode Settings -->
      <div class="config-row">
        <label class="config-label">Capture Mode:</label>
        <select class="mode-dropdown" id="captureModeSelect">
          <option value="fullscreen">📱 Full Screen</option>
          <option value="area">🎯 Select Area</option>
        </select>
      </div>

      <!-- Auto Copy Settings -->
      <div class="config-row">
        <label class="config-label">Auto Copy:</label>
        <label class="toggle-switch">
          <input type="checkbox" id="autoCopyToggle" checked />
          <span class="toggle-slider"></span>
        </label>
      </div>
    </div>

    <!-- Capture Section -->
    <div class="capture-section">
      <button class="capture-button" id="captureBtn">
        📸 Capture Screen Area
      </button>
    </div>

    <!-- Status Section -->
    <div class="status-section">
      <div class="status-indicator" id="statusIndicator">
        <div class="status-icon" id="statusIcon"></div>
        <span id="statusText">Ready to capture</span>
      </div>
    </div>

    <!-- Capture Preview Section -->
    <div
      class="capture-preview-section"
      id="capturePreviewSection"
      style="display: none"
    >
      <div class="section-title">Capture Preview</div>
      <div class="preview-container">
        <img
          id="capturePreview"
          class="capture-preview-image"
          alt="Captured area preview"
        />
        <div class="preview-info">
          <span id="previewDimensions"></span>
        </div>
      </div>
    </div>

    <!-- Results Section -->
    <div class="results-section">
      <div class="results-header">
        <div class="results-title">Extracted Text</div>
        <button class="copy-button" id="copyBtn" style="display: none">
          Copy
        </button>
      </div>
      <div class="results-text" id="resultsText"></div>
    </div>

    <!-- Shortcut Section -->
    <div class="shortcut-section">
      <span class="shortcut-text">Global Shortcut:</span>
      <div class="shortcut-keys">
        <span class="key">⌘</span>
        <span class="key">Shift</span>
        <span class="key">2</span>
      </div>
    </div>

    <script>
      const { ipcRenderer } = require("electron");

      // DOM Elements
      const captureBtn = document.getElementById("captureBtn");
      const statusIcon = document.getElementById("statusIcon");
      const statusText = document.getElementById("statusText");
      const resultsText = document.getElementById("resultsText");
      const copyBtn = document.getElementById("copyBtn");
      const languageSelect = document.getElementById("languageSelect");
      const captureModeSelect = document.getElementById("captureModeSelect");
      const autoCopyToggle = document.getElementById("autoCopyToggle");
      const permissionBanner = document.getElementById("permissionBanner");
      const openPreferencesBtn = document.getElementById("openPreferencesBtn");
      const recheckPermissionBtn = document.getElementById(
        "recheckPermissionBtn"
      );
      const settingsIcon = document.getElementById("settingsIcon");
      const languageManagementIcon = document.getElementById(
        "languageManagementIcon"
      );
      const backIcon = document.getElementById("backIcon");
      const configSection = document.getElementById("configSection");
      const capturePreviewSection = document.getElementById(
        "capturePreviewSection"
      );
      const capturePreview = document.getElementById("capturePreview");
      const previewDimensions = document.getElementById("previewDimensions");

      // Drag selection elements
      const dragOverlay = document.getElementById("dragOverlay");
      const selectionArea = document.getElementById("selectionArea");
      const dragInstructions = document.getElementById("dragInstructions");

      let currentConfig = null;

      // Drag selection state
      let isSelecting = false;
      let startX, startY, endX, endY;
      let captureInProgress = false;

      // Initialize app
      async function initializeApp() {
        try {
          currentConfig = await ipcRenderer.invoke("get-config");
          populateLanguageDropdown();
          languageSelect.value = currentConfig.language;
          captureModeSelect.value = currentConfig.captureMode || "fullscreen";
          autoCopyToggle.checked = currentConfig.autoCopy !== false;

          // Update capture button text based on mode
          updateCaptureButtonText();

          // Check permissions
          const hasPermission = await ipcRenderer.invoke("check-permissions");
          updatePermissionUI(hasPermission);
        } catch (error) {
          console.error("Failed to initialize app:", error);
        }
      }

      function updateCaptureButtonText() {
        const mode = captureModeSelect.value;
        if (mode === "fullscreen") {
          captureBtn.textContent = "📱 Capture Full Screen";
        } else {
          captureBtn.textContent = "🎯 Select Area to Capture";
        }
      }

      function populateLanguageDropdown() {
        if (!currentConfig || !currentConfig.supportedLanguages) return;

        languageSelect.innerHTML = "";
        
        // Add Auto Detect option first
        const autoOption = document.createElement("option");
        autoOption.value = "auto";
        autoOption.textContent = "🔍 Auto Detect";
        languageSelect.appendChild(autoOption);
        
        // Add installed languages
        currentConfig.supportedLanguages.forEach((lang) => {
          const option = document.createElement("option");
          option.value = lang.code;
          option.textContent = `${lang.flag} ${lang.name}`;
          languageSelect.appendChild(option);
        });
      }

      function updatePermissionUI(hasPermission) {
        if (hasPermission) {
          permissionBanner.style.display = "none";
          captureBtn.disabled = false;
          updateStatus("ready", "Ready to capture");
        } else {
          permissionBanner.style.display = "block";
          captureBtn.disabled = true;
          updateStatus("permission-denied", "Permission required");
        }
      }

      function updateStatus(type, message) {
        statusIcon.className = `status-icon ${type}`;
        statusText.textContent = message;
      }

      // Event Listeners
      captureBtn.addEventListener("click", () => {
        ipcRenderer.send("start-capture");
      });

      languageSelect.addEventListener("change", async () => {
        try {
          await ipcRenderer.invoke("set-language", languageSelect.value);
          currentConfig.language = languageSelect.value;
        } catch (error) {
          console.error("Failed to set language:", error);
        }
      });

      captureModeSelect.addEventListener("change", async () => {
        try {
          await ipcRenderer.invoke(
            "set-config",
            "captureMode",
            captureModeSelect.value
          );
          currentConfig.captureMode = captureModeSelect.value;

          // Update capture button text when mode changes
          updateCaptureButtonText();
        } catch (error) {
          console.error("Failed to set capture mode:", error);
        }
      });

      autoCopyToggle.addEventListener("change", async () => {
        try {
          await ipcRenderer.invoke(
            "set-config",
            "autoCopy",
            autoCopyToggle.checked
          );
          currentConfig.autoCopy = autoCopyToggle.checked;
        } catch (error) {
          console.error("Failed to set auto copy:", error);
        }
      });

      copyBtn.addEventListener("click", () => {
        if (resultsText.textContent) {
          navigator.clipboard.writeText(resultsText.textContent);
          copyBtn.textContent = "Copied!";
          setTimeout(() => {
            copyBtn.textContent = "Copy";
          }, 2000);
        }
      });

      openPreferencesBtn.addEventListener("click", async () => {
        try {
          await ipcRenderer.invoke("open-system-preferences");
        } catch (error) {
          console.error("Failed to open system preferences:", error);
        }
      });

      recheckPermissionBtn.addEventListener("click", async () => {
        try {
          recheckPermissionBtn.textContent = "Checking...";
          recheckPermissionBtn.disabled = true;

          const hasPermission = await ipcRenderer.invoke("check-permissions");
          updatePermissionUI(hasPermission);

          if (!hasPermission) {
            recheckPermissionBtn.textContent = "Still No Permission";
            setTimeout(() => {
              recheckPermissionBtn.textContent = "Recheck Permissions";
              recheckPermissionBtn.disabled = false;
            }, 2000);
          }
        } catch (error) {
          console.error("Failed to recheck permissions:", error);
          recheckPermissionBtn.textContent = "Recheck Permissions";
          recheckPermissionBtn.disabled = false;
        }
      });

      // Settings toggle functionality
      settingsIcon.addEventListener("click", () => {
        configSection.style.display = "block";
      });

      backIcon.addEventListener("click", () => {
        configSection.style.display = "none";
      });

      // Language Management toggle functionality
      languageManagementIcon.addEventListener("click", async () => {
        try {
          await ipcRenderer.invoke("show-language-management");
        } catch (error) {
          console.error("Failed to open language management:", error);
        }
      });

      // Add language management button functionality
      const languageManagementBtn = document.createElement("button");
      languageManagementBtn.textContent = "🌍 Manage Languages";
      languageManagementBtn.className = "language-management-btn";
      languageManagementBtn.style.cssText = `
        background: #2563eb;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 12px 20px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        margin-top: 16px;
        width: 100%;
        transition: background 0.2s;
      `;

      languageManagementBtn.addEventListener("mouseover", () => {
        languageManagementBtn.style.background = "#1d4ed8";
      });

      languageManagementBtn.addEventListener("mouseout", () => {
        languageManagementBtn.style.background = "#2563eb";
      });

      languageManagementBtn.addEventListener("click", async () => {
        try {
          await ipcRenderer.invoke("show-language-management");
        } catch (error) {
          console.error("Failed to open language management:", error);
        }
      });

      // Add the button to the config section
      const configContent = configSection.querySelector(".config-content");
      if (configContent) {
        configContent.appendChild(languageManagementBtn);
      }

      // IPC Event Listeners
      ipcRenderer.on("trigger-capture", () => {
        if (!captureBtn.disabled) {
          ipcRenderer.send("start-capture");
        }
      });

      // Handle enable-drag-selection from main process
      ipcRenderer.on("enable-drag-selection", () => {
        enableDragSelection();
      });

      ipcRenderer.on("permission-denied", () => {
        updatePermissionUI(false);
      });

      ipcRenderer.on("processing-ocr", () => {
        updateStatus("processing", "Processing OCR...");
        captureBtn.disabled = true;
      });

      ipcRenderer.on("ocr-progress", (event, progress) => {
        if (progress.status === "recognizing text") {
          updateStatus(
            "processing",
            `Processing: ${Math.round(progress.progress * 100)}%`
          );
        }
      });

      ipcRenderer.on("ocr-complete", (event, text) => {
        updateStatus("ready", "Text extracted successfully!");
        resultsText.textContent = text || "No text detected";
        copyBtn.style.display = text ? "block" : "none";
        captureBtn.disabled = false;

        setTimeout(() => {
          updateStatus("ready", "Ready to capture");
        }, 3000);
      });

      // Enhanced capture preview handler with better error handling
      ipcRenderer.on("capture-preview", (event, imageData, dimensions) => {
        console.log("Received capture preview:", {
          imageData: imageData ? "present" : "missing",
          dimensions,
        });

        if (imageData) {
          capturePreview.src = imageData;

          // Update dimensions display
          if (dimensions) {
            previewDimensions.textContent = `${dimensions.width} × ${dimensions.height} pixels`;
          }

          // Ensure preview section is visible
          capturePreviewSection.style.display = "block";

          // Update status to show successful capture
          updateStatus("success", "Area captured successfully!");

          // Reset capture state
          captureInProgress = false;
        } else {
          console.error("Invalid capture preview data:", {
            imageData,
            dimensions,
          });
          updateStatus("error", "Failed to display capture preview");
          capturePreviewSection.style.display = "none";
          captureInProgress = false;
        }
      });

      ipcRenderer.on("ocr-error", (event, error) => {
        updateStatus("error", `Error: ${error}`);
        resultsText.textContent = "";
        copyBtn.style.display = "none";
        captureBtn.disabled = false;

        setTimeout(() => {
          updateStatus("ready", "Ready to capture");
        }, 5000);
      });

      // Initialize when DOM is loaded
      document.addEventListener("DOMContentLoaded", initializeApp);

      // Enhanced enableDragSelection function with automatic app hiding
      function enableDragSelection() {
        console.log("🎯 Enabling drag selection mode");

        if (captureInProgress) return;

        // Hide the main application window during drag capture
        if (window.electronAPI && window.electronAPI.hideWindow) {
          window.electronAPI.hideWindow();
        } else if (window.ipcRenderer) {
          window.ipcRenderer.send("hide-main-window");
        }

        dragOverlay.style.display = "flex";
        dragInstructions.style.display = "block";
        capturePreviewSection.style.display = "none";

        // Reset selection state
        isSelecting = false;
        captureInProgress = false;

        // Clear any previous selection
        selectionArea.style.display = "none";
        selectionArea.style.left = "0px";
        selectionArea.style.top = "0px";
        selectionArea.style.width = "0px";
        selectionArea.style.height = "0px";

        updateStatus(
          "info",
          "Drag to select capture area. Press Escape to cancel."
        );
      }

      // Enhanced disableDragSelection function with automatic app restoration
      function disableDragSelection() {
        console.log("🚫 Disabling drag selection mode");

        dragOverlay.style.display = "none";
        selectionArea.style.display = "none";
        dragInstructions.style.display = "none";

        // Reset selection state
        isSelecting = false;
        captureInProgress = false;

        // Restore the main application window
        if (window.electronAPI && window.electronAPI.showWindow) {
          window.electronAPI.showWindow();
        } else if (window.ipcRenderer) {
          window.ipcRenderer.send("show-main-window");
        }

        updateStatus("ready", "Ready to capture");
        resetSelection();
      }

      function resetSelection() {
        if (selectionArea) {
          selectionArea.style.left = "0px";
          selectionArea.style.top = "0px";
          selectionArea.style.width = "0px";
          selectionArea.style.height = "0px";
          selectionArea.style.display = "none";
        }
      }

      // Enhanced mouse event handlers for drag selection with preview support
      dragOverlay.addEventListener("mousedown", (event) => {
        if (captureInProgress) return;

        isSelecting = true;
        startX = event.clientX;
        startY = event.clientY;

        // Initialize selection area
        selectionArea.style.left = startX + "px";
        selectionArea.style.top = startY + "px";
        selectionArea.style.width = "0px";
        selectionArea.style.height = "0px";
        selectionArea.style.display = "block";

        // Hide instructions and show preview section
        dragInstructions.style.display = "none";
        capturePreviewSection.style.display = "block";

        // Clear any previous preview
        capturePreview.src = "";
        previewDimensions.textContent = "Selecting area...";
      });

      dragOverlay.addEventListener("mousemove", (event) => {
        if (!isSelecting || captureInProgress) return;

        endX = event.clientX;
        endY = event.clientY;

        const left = Math.min(startX, endX);
        const top = Math.min(startY, endY);
        const width = Math.abs(endX - startX);
        const height = Math.abs(endY - startY);

        // Update selection area visually
        selectionArea.style.left = left + "px";
        selectionArea.style.top = top + "px";
        selectionArea.style.width = width + "px";
        selectionArea.style.height = height + "px";

        // Update preview dimensions in real-time
        previewDimensions.textContent = `${width} × ${height} pixels`;
      });

      dragOverlay.addEventListener("mouseup", async (event) => {
        if (!isSelecting || captureInProgress) return;

        isSelecting = false;
        captureInProgress = true;

        endX = event.clientX;
        endY = event.clientY;

        const left = Math.min(startX, endX);
        const top = Math.min(startY, endY);
        const width = Math.abs(endX - startX);
        const height = Math.abs(endY - startY);

        // Validate selection size
        if (width < 10 || height < 10) {
          updateStatus(
            "error",
            "Selection too small. Please select a larger area."
          );
          disableDragSelection();
          capturePreviewSection.style.display = "none";
          captureInProgress = false;
          return;
        }

        // Keep preview visible during capture
        previewDimensions.textContent = `Capturing ${width} × ${height} pixels...`;

        await processAreaCapture(left, top, width, height);
      });

      // Keyboard event handler for ESC key
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && dragOverlay.style.display === "block") {
          disableDragSelection();
        }
      });

      // Enhanced processAreaCapture function with improved preview handling
      async function processAreaCapture(x, y, width, height) {
        try {
          updateStatus("info", "Capturing selected area...");

          // Keep preview section visible during capture
          capturePreviewSection.style.display = "block";
          previewDimensions.textContent = `Processing ${width} × ${height} pixels...`;

          const captureData = {
            x: x,
            y: y,
            width: width,
            height: height,
            timestamp: Date.now(),
          };

          // Send capture request to main process
          ipcRenderer.send("area-selected", captureData);

          // Keep the selection area visible briefly to show what was captured
          setTimeout(() => {
            disableDragSelection();
          }, 500);
        } catch (error) {
          console.error("Error in processAreaCapture:", error);
          updateStatus(
            "error",
            "Failed to process area capture: " + error.message
          );
          disableDragSelection();
          capturePreviewSection.style.display = "none";
          captureInProgress = false;
        }
      }
    </script>
  </body>
</html>
