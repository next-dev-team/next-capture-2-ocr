<!DOCTYPE html>
<html>
<head>
    <title>Image Processing</title>
</head>
<body>
    <canvas id="canvas"></canvas>
    <script>
        const { ipcRenderer } = require('electron');
        
        // Listen for processing request
        ipcRenderer.on('process-image', (event, data) => {
            // Store data globally for access in debug code
            window.processImageData = data;
            
            try {
                const canvas = document.getElementById('canvas');
                const ctx = canvas.getContext('2d');
                
                canvas.width = data.bounds.width;
                canvas.height = data.bounds.height;
                
                const img = new Image();
                img.onload = () => {
                    try {
                        console.log('ðŸ–¼ï¸ DEBUG: Image loaded - dimensions:', img.width, 'x', img.height);
                        console.log('ðŸ” DEBUG: Crop bounds received:', data.bounds);
                        
                        console.log('ðŸŽ¨ DEBUG: Canvas created - dimensions:', canvas.width, 'x', canvas.height);
                        console.log('ðŸ” DEBUG: Drawing image with params:', {
                            sx: data.bounds.x,
                            sy: data.bounds.y,
                            sWidth: data.bounds.width,
                            sHeight: data.bounds.height,
                            dx: 0,
                            dy: 0,
                            dWidth: data.bounds.width,
                            dHeight: data.bounds.height
                        });
                        
                        // Draw the cropped area
                        ctx.drawImage(
                            img, 
                            data.bounds.x, data.bounds.y, data.bounds.width, data.bounds.height,
                            0, 0, data.bounds.width, data.bounds.height
                        );
                        
                        const processedImageData = canvas.toDataURL('image/png');
                        
                        // DEBUG: Save the cropped image to see what we're actually processing
                        const fs = require('fs');
                        const path = require('path');
                        const debugImagePath = path.join(window.processImageData.debugPath, `debug_cropped_${Date.now()}.png`);
                        const base64Data = processedImageData.replace(/^data:image\/png;base64,/, '');
                        fs.writeFileSync(debugImagePath, base64Data, 'base64');
                        console.log('ðŸ” DEBUG: Cropped image saved to:', debugImagePath);
                        
                        // Send result back to main process
                        ipcRenderer.send('image-processing-complete', processedImageData);
                    } catch (error) {
                        console.error('ðŸš¨ DEBUG: Canvas processing error:', error);
                        ipcRenderer.send('image-processing-error', error.message);
                    }
                };
                
                img.onerror = (error) => {
                    ipcRenderer.send('image-processing-error', 'Failed to load image');
                };
                
                img.src = data.imageDataUrl;
                
            } catch (error) {
                ipcRenderer.send('image-processing-error', error.message);
            }
        });
        
        // Signal that we're ready
        ipcRenderer.send('image-processor-ready');
    </script>
</body>
</html>